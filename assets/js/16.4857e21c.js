(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{404:function(t,s,a){"use strict";a.r(s);var n=a(13),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"背景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[t._v("#")]),t._v(" 背景")]),t._v(" "),a("p",[t._v("最近入手了一个 QNAP 的 NAS 由于住处的网络是公寓统一的，所以没有路由器权限，不能使用路由器的 DDNS 进行端口转发；只能另做它法，以前为了穿透公司的内网研究了 frp，而且实验成功了")]),t._v(" "),a("p",[t._v("上次也没有记录怎么处理的，这次有需要顺便记录一下。由于 NAS 有点小瑕疵店家叫发回去换一个，"),a("s",[t._v("所以客户端那边暂时不写，先在我的 Tencent Cloud 有公网 IP 的 VPS 搭建好 frp Server")])]),t._v(" "),a("p",[t._v("参考：")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://github.com/fatedier/frp",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/fatedier/frp"),a("OutboundLink")],1)])]),t._v(" "),a("blockquote",[a("p",[t._v("有公网 IP 的或者拨号路由器由自己控制的，可以不通过 frp 来实现；直接使用路由器的 DDNS + 花生壳之类的实现就可以了")])]),t._v(" "),a("h2",{attrs:{id:"frp-server-安装笔记"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#frp-server-安装笔记"}},[t._v("#")]),t._v(" frp Server 安装笔记")]),t._v(" "),a("p",[t._v("先 SSH 登录自己的云服务器，去 Github 上找到 frp 项目的 "),a("a",{attrs:{href:"https://github.com/fatedier/frp/releases",target:"_blank",rel:"noopener noreferrer"}},[t._v("Release"),a("OutboundLink")],1),t._v(" 页面，找到 Latest Release 下载对应系统的版本，例如使用 Ubuntu 18.04 64 位系统就下载 "),a("code",[t._v("frp_0.xxx.0_linux_amd64.tar.gz")]),t._v("，例如我下载的时候是 0.33.0 版本")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 下载")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://github.com/fatedier/frp/releases/download/v0.33.0/frp_0.33.0_linux_amd64.tar.gz\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 解压")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" -zxvf frp_0.33.0_linux_amd64.tar.gz\n")])])]),a("p",[t._v("这里安装的话分几种形式，比如去改 frps.service 文件的，或者不改文件，复制相关文件到对应目录的；我这里采用不改 service 文件，而是采用复制对应的文件到对应的位置")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 具体位置是依据 frp_0.33.0_linux_amd64/systemd/frps.service 的配置来决定的")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ExecStart=/usr/bin/frps -c /etc/frp/frps.ini")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 复制可执行文件")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" frps /usr/bin/\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 复制配置文件")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p /etc/frp/ "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" frps.ini /etc/frp/\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 复制 service 文件")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" systemd/frps.service /ete/systemd/system/\n")])])]),a("p",[t._v("修改 frpS 的配置")]),t._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token selector"}},[t._v("[common]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 各个端口的绑定")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("bind_port")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" 7777")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("kcp_bind_port")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" 7777")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("bind_udp_port")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" 7778")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 管理界面配置")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("dashboard_port")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" 7779")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("dashboard_user")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" xxx")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("dashboard_pwd")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" xxxxx")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 日志配置")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("log_file")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" /var/log/frps.log")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# trace, debug, info, warn, error")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("log_level")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" warn")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("log_max_days")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" 7")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 客户端要填对了 Token 才可以使用")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("token")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" xxxx")]),t._v("\n")])])]),a("blockquote",[a("p",[t._v("这里要要确定你的 VPS 的上述端口是开放的")])]),t._v(" "),a("p",[t._v("然后执行 "),a("code",[t._v("systemctl start frps.service")]),t._v("，正常情况下已经搭建成功了")]),t._v(" "),a("p",[t._v("可以通过 http://yourdomain:dashboard_port 访问控制台，输入对应设置的账号密码即可")]),t._v(" "),a("h2",{attrs:{id:"frp-client-安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#frp-client-安装"}},[t._v("#")]),t._v(" frp Client 安装")]),t._v(" "),a("p",[t._v("客户端其实主要也是配置如何编写")]),t._v(" "),a("ol",[a("li",[t._v("下载 frp，这里选择要进行内网穿透的系统类型，按情况下载")]),t._v(" "),a("li",[t._v("把 frpc 复制到某个目录，修改 frpc.ini 就可以了")]),t._v(" "),a("li",[t._v("看情况要不要设置成开机启动，这里不同的操作系统都不一样，需要的自己搜索如何操作即可")])]),t._v(" "),a("p",[t._v("重点讲一下如何在我的 QNAP 上设置 frpc，因为资料比较少，一般推荐使用容器，有点奇怪；既然 QTS 本质是一个 Linux（并不完整，很多功能没有，比如 systemd/init.d 都没有，自启动不能依赖它们），那么我们直接通过 QNAP 的 "),a("code",[t._v("autorun.sh")]),t._v(" 来让 frpc 开机自动运行")]),t._v(" "),a("p",[t._v("根据 QNAP 官方的 wiki，找到如下的 autorun.sh 的编辑方法")]),t._v(" "),a("blockquote",[a("p",[a("a",{attrs:{href:"https://wiki.qnap.com/wiki/Running_Your_Own_Application_at_Startup",target:"_blank",rel:"noopener noreferrer"}},[t._v("Running Your Own Application at Startup"),a("OutboundLink")],1)])]),t._v(" "),a("ol",[a("li",[t._v("首先在设置里开启 ssh 登录")]),t._v(" "),a("li",[t._v("通过 ssh 连接上 NAS")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# SSH 连接 NAS")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ssh")]),t._v(" admin@192.168.x.xxx\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 挂载")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mount")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("/sbin/hal_app --get_boot_pd "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("port_id")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v(" /tmp/config\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 编辑文件")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" /tmp/config/autorun.sh\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 赋权")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("chmod")]),t._v(" a+x /tmp/config/autorun.sh \n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 取消挂载，这里官方标注为 IMPORTANT")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("umount")]),t._v(" /tmp/config\n")])])]),a("p",[t._v("frp 的文件放在哪里也有讲究，如果直接放在系统安装目录下面重启之后会消失；感觉 QTS 启动那么慢就是因为每次启动都是把系统镜像重新安装了一次")]),t._v(" "),a("p",[t._v("所以要找到你的磁盘，把文件放到那里面，其实这样的话我们可以不用把文件拷贝到系统中了，可以通过共享目录就拷贝进去了；但是这个看个人了 QTS 的磁盘都挂载在 "),a("code",[t._v("/share")]),t._v(" 下面，而且你建立的共享文件夹它都设置了符号链接，比如，我就将 frp 相关的文件放在了")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("/share/playground/frp/\n")])])]),a("p",[t._v("这里重点说一下 autorun.sh 里面命令编写遇到的问题")]),t._v(" "),a("p",[a("code",[t._v("frpc")]),t._v(" 的命令是阻塞的，不结束就会阻塞后面的操作；因为这个原因导致 NAS 重启之后优先级低一点的应用程序总是启动不了，导致 NAS 各种功能没法用；因为这个原因导致我还重置 NAS，浪费了大量的时间。")]),t._v(" "),a("p",[t._v("所以我们要将命令写成如下这样")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# for frp")]),t._v("\n/share/playground/frp/frpc -c /share/playground/frp/frpc.ini "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("\n")])])]),a("p",[t._v("后面加个 "),a("code",[t._v("&")]),t._v(" ，这样处理之后就可以正常启动其他的程序了。")]),t._v(" "),a("p",[a("code",[t._v("frpc.ini")]),t._v(" 文件示例：")]),t._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token selector"}},[t._v("[common]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("server_addr")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" xxxxxxx")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("server_port")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" xxxx")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("token")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" xxxxxxxxx")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("; NAS 管理窗口 HTTP 映射")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token selector"}},[t._v("[nas_http]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("type")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" tcp")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("local_ip")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" 127.0.0.1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("local_port")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" 5000")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("remote_port")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" xxxx")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("; SSH 端口映射")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token selector"}},[t._v("[ssh]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("type")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" tcp")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("local_ip")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" 127.0.0.1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("local_port")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" 22")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("remote_port")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" xxxx")]),t._v("\n")])])]),a("p",[t._v("这样你就可以通过你的域名 + 端口号来愉快的访问你的 NAS 了")])])}),[],!1,null,null,null);s.default=e.exports}}]);